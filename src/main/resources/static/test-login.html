<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>로그인 테스트 (JWT)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif; background:#f6f7fb; margin:0; }
        .wrap { max-width: 720px; margin: 40px auto; background:#fff; padding:28px; border-radius:14px; box-shadow: 0 6px 24px rgba(0,0,0,.06);}
        h1 { margin: 0 0 16px; }
        .row { display:flex; gap:12px; margin:10px 0; }
        .col { flex:1; }
        label { display:block; font-size:13px; color:#555; margin-bottom:6px; }
        input { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; outline:none; }
        input:focus { border-color:#6c5ce7; box-shadow:0 0 0 3px rgba(108,92,231,.15);}
        button { padding:12px 16px; border:0; border-radius:10px; cursor:pointer; font-weight:600; }
        .btn { background:#6c5ce7; color:#fff; }
        .btn.sub { background:#e0e0ff; color:#4730d9; }
        .btn.danger { background:#ff7675; color:#fff; }
        .stack { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;}
        .card { background:#fafafa; border:1px solid #eee; padding:14px; border-radius:10px; }
        pre { background:#0b1021; color:#e6edf3; padding:12px; border-radius:8px; overflow:auto; max-height:220px; }
        .muted { color:#777; font-size:12px; }
    </style>
</head>
<body>
<div class="wrap">
    <h1>JWT 로그인 테스트 페이지</h1>
    <p class="muted">백엔드: <code id="base-url">http://localhost:8080</code> (필요 시 수정)</p>

    <div class="row">
        <div class="col">
            <label for="email">이메일</label>
            <input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div class="col">
            <label for="password">비밀번호</label>
            <input id="password" type="password" placeholder="••••••••" />
        </div>
    </div>

    <div class="stack">
        <button class="btn sub" id="registerBtn">회원가입</button>
        <button class="btn" id="loginBtn">로그인</button>
        <button class="btn danger" id="logoutBtn">로그아웃</button>
        <button class="btn sub" id="validateBtn">토큰 검증 호출</button>
    </div>

    <div class="card" style="margin-top:16px">
        <strong>현재 저장된 JWT</strong>
        <pre id="tokenBox">토큰 없음</pre>
        <div class="muted">localStorage key: <code>authToken</code></div>
    </div>

    <div class="card" style="margin-top:16px">
        <strong>응답 / 로그</strong>
        <pre id="logBox">대기중…</pre>
    </div>

    <div class="card" style="margin-top:16px">
        <strong>설정</strong>
        <div class="row">
            <div class="col">
                <label for="baseUrlInput">BASE_URL</label>
                <input id="baseUrlInput" type="text" value="http://localhost:8080" />
            </div>
            <div class="col" style="align-self:flex-end">
                <button class="btn sub" id="applyBaseUrl">적용</button>
            </div>
        </div>
        <div class="muted">엔드포인트:
            <ul>
                <li><code>POST /auth/register</code> → { email, password }</li>
                <li><code>POST /auth/login</code> → { email, password } ⇒ { accessToken }</li>
                <li><code>GET /api/health</code> (예시, 보호 자원) → Authorization: Bearer &lt;token&gt;</li>
            </ul>
        </div>
    </div>
</div>

<script>
    let BASE_URL = 'http://localhost:8080';
    const $ = (id) => document.getElementById(id);
    const tokenKey = 'authToken';

    function log(...args) {
        const box = $('logBox');
        const msg = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a, null, 2))).join(' ');
        box.textContent = msg;
    }

    function loadToken() {
        const t = localStorage.getItem(tokenKey);
        $('tokenBox').textContent = t || '토큰 없음';
        return t;
    }

    function saveToken(t) {
        if (t) localStorage.setItem(tokenKey, t);
        $('tokenBox').textContent = t || '토큰 없음';
    }

    function clearToken() {
        localStorage.removeItem(tokenKey);
        $('tokenBox').textContent = '토큰 없음';
    }

    // 초기화
    window.addEventListener('DOMContentLoaded', () => {
        loadToken();
        $('base-url').textContent = BASE_URL;
        $('baseUrlInput').value = BASE_URL;

        $('applyBaseUrl').onclick = () => {
            BASE_URL = $('baseUrlInput').value.trim() || BASE_URL;
            $('base-url').textContent = BASE_URL;
            log('BASE_URL 적용:', BASE_URL);
        };

        $('registerBtn').onclick = async () => {
            const email = $('email').value.trim();
            const password = $('password').value;
            if (!email || !password) return log('이메일/비밀번호를 입력하세요.');

            try {
                const res = await fetch(`${BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                if (!res.ok) {
                    const text = await res.text();
                    return log('회원가입 실패:', res.status, text);
                }
                log('회원가입 성공');
            } catch (e) {
                log('회원가입 오류:', e.message);
            }
        };

        $('loginBtn').onclick = async () => {
            const email = $('email').value.trim();
            const password = $('password').value;
            if (!email || !password) return log('이메일/비밀번호를 입력하세요.');

            try {
                const res = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    return log('로그인 실패:', res.status, data || await res.text());
                }
                const token = data && (data.accessToken || data.token || data.jwt);
                if (!token) return log('응답에 토큰 필드가 없습니다:', data);

                saveToken(token);
                log('로그인 성공:\n' + JSON.stringify(data, null, 2));
            } catch (e) {
                log('로그인 오류:', e.message);
            }
        };

        $('logoutBtn').onclick = () => {
            clearToken();
            log('로그아웃 처리: 로컬 저장된 토큰 삭제(서버 상태리스)');
        };

        $('validateBtn').onclick = async () => {
            const t = loadToken();
            if (!t) return log('토큰이 없습니다.');
            // 예시 보호 API. 실제 사용 중인 엔드포인트로 바꾸세요.
            try {
                const res = await fetch(`${BASE_URL}/api/health`, {
                    headers: { 'Authorization': `Bearer ${t}` }
                });
                const text = await res.text();
                log('보호 API 호출 응답:\n' + text);
            } catch (e) {
                log('호출 오류:', e.message);
            }
        };
    });
</script>
</body>
</html>